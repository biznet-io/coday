üî¨-test:
  stage: üî¨-test
  image: none
  before_script:
    - !reference [ .setup, configureWorkingDirectory ]
  tags:
    - bare-metal
  needs: [ 1Ô∏è‚É£-init-repository ]
  script:
    - |
      if [ $CI_MERGE_REQUEST_TARGET_BRANCH_NAME ]; then
        export NX_BASE=$CI_MERGE_REQUEST_TARGET_BRANCH_NAME
      else
        export NX_BASE=$CI_COMMIT_REF_SLUG
      fi
      echo "NX_BASE:" $NX_BASE

      if [ "$FORCE_VALIDATE_JOBS" = "true" ]; then
        echo "FORCE_VALIDATE_JOBS is true, running $FRONTEND_CHECK_TYPE on all projects";
        yarn nx run-many --all --target="lint,test" --parallel=$NX_MAX_WORKERS
      else
        echo "FORCE_VALIDATE_JOBS is false, running $FRONTEND_CHECK_TYPE on affected projects only";
        yarn nx affected --base=origin/$NX_BASE --head=HEAD --target="lint,test" --parallel=$NX_MAX_WORKERS;
      fi
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true" && $FORCE_VALIDATE_JOBS == "true"
    - if: $CI_MERGE_REQUEST_ID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $MASTER_BRANCH
